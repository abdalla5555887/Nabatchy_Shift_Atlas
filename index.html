<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¨Ø·Ø´ÙŠØ§Øª - Nabatchy Pro</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            direction: rtl;
        }

        .container {
            width: 98%;
            background: white;
            padding: 15px;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
            margin-bottom: 5px;
        }

        th, td {
            border: 1px solid #000;
            text-align: center;
            padding: 4px 6px;
            font-size: 11px; 
            vertical-align: middle;
            color: #000;
        }

        th { background-color: #eee; font-weight: bold; }

        .shift-cell { cursor: pointer; transition: 0.2s; min-height: 25px; min-width: 120px; }
        .shift-cell:hover { background-color: #f0f7ff; }
        .selected-cell { background-color: #fff9c4 !important; outline: 2px solid #fbc02d; font-weight: bold; }

        h1 { text-align: center; font-size: 18px; margin: 0 0 15px 0; text-decoration: underline; font-weight: bold; }

        .codes-list { margin-top: 15px; font-size: 11px; font-weight: bold; }
        .code-row input { border: none; background: transparent; font-weight: bold; width: 100%; font-family: inherit; }
        
        .signatures-wrapper { display: flex; justify-content: space-between; margin-top: 20px; padding: 0 20px; font-weight: bold; }
        .sig-block { text-align: center; width: 250px; }
        .sig-block input { border: none; text-align: center; font-weight: bold; width: 100%; font-size: 12px; background: transparent; margin-top: 5px; }

        .controls-panel {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 8px;
        }
        
        .worker-btn { padding: 6px 12px; margin: 2px; cursor: pointer; font-size: 12px; border: 1px solid #999; border-radius: 3px; background: #fff;}
        .worker-btn.active { background: #007bff; color: #fff; border-color: #0056b3; box-shadow: 0 0 5px rgba(0,123,255,0.5); }

        .history-tag {
            display: inline-flex;
            align-items: center;
            background: #e3f2fd;
            color: #007bff;
            padding: 4px 10px;
            margin: 5px;
            border-radius: 15px;
            font-size: 11px;
            border: 1px solid #007bff;
            gap: 8px;
        }
        
        .history-name { cursor: pointer; font-weight: bold; }
        .history-actions { display: flex; gap: 4px; opacity: 0.7; }
        .history-actions span { cursor: pointer; padding: 0 3px; }
        .history-actions span:hover { opacity: 1; font-weight: bold; color: #0056b3; }

        .bulk-options { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: #fff; padding: 10px; border-radius: 5px; border: 1px solid #ccc; margin-bottom: 10px; }
        .day-chip { background: #f8f9fa; border: 1px solid #ddd; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .day-chip input { margin-left: 5px; cursor: pointer; }

        /* Ø³ØªØ§ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .stats-table { width: 100%; margin-top: 10px; border: 2px solid #333; }
        .stats-table th { background: #007bff; color: white; padding: 8px; }
        .stats-table td { font-weight: bold; font-size: 13px; }
        .stats-row:nth-child(even) { background-color: #f2f2f2; }

        @media print {
            .controls-panel, .setup-bar, .history-section, .no-print { display: none !important; }
            @page { size: A4 landscape; margin: 5mm; }
            body { padding: 0; margin: 0; background: white; }
            .container { box-shadow: none; width: 100%; padding: 0; }
            html { zoom: 82%; } 
            table { width: 100% !important; border: 1px solid #000 !important; }
            th, td { border: 1px solid #000 !important; }
            /* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„ÙƒÙ† Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù†ÙØ³Ù‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ */
            #generateStatsBtn { display: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 id="tableTitle">Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠÙŠÙ† ÙˆØ§Ù„ÙÙ†ÙŠÙŠÙ† Ø¨Ø¨Ù†Ùƒ Ø§Ù„Ø¯Ù… Ø¹Ù† Ø´Ù‡Ø± ...</h1>

    <div class="setup-bar" style="text-align:center; padding:10px; background:#f8f9fa; margin-bottom:10px; border: 1px solid #ddd;">
        <label>Ø§Ù„Ø´Ù‡Ø±: </label>
        <select id="monthSelect" onchange="generateTable()">
            <option value="1">ÙŠÙ†Ø§ÙŠØ±</option><option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option><option value="3">Ù…Ø§Ø±Ø³</option>
            <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option><option value="5">Ù…Ø§ÙŠÙˆ</option><option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
            <option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option><option value="8">Ø£ØºØ³Ø·Ø³</option><option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
            <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option><option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option><option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
        </select>
        <label> Ø§Ù„Ø³Ù†Ø©: </label>
        <input type="number" id="yearSelect" value="2026" style="width:65px;" onchange="generateTable()">
        
        <button onclick="saveToHistory()" style="background:#28a745; color:white; border:none; padding:5px 15px; cursor:pointer; margin-right:5px; font-weight:bold; border-radius:4px;">ğŸ’¾ Ø­ÙØ¸ Ø¨Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
        <button onclick="downloadBackup()" style="background:#fd7e14; color:white; border:none; padding:5px 15px; cursor:pointer; margin-right:5px; font-weight:bold; border-radius:4px;">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù</button>
        <button onclick="document.getElementById('backupInput').click()" style="background:#6f42c1; color:white; border:none; padding:5px 15px; cursor:pointer; margin-right:5px; font-weight:bold; border-radius:4px;">ğŸ“¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù„Ù</button>
        <input type="file" id="backupInput" style="display:none" accept=".json" onchange="restoreBackup(this)">
        <button onclick="window.print()" style="background:#007bff; color:white; border:none; padding:5px 15px; cursor:pointer; margin-right:5px; font-weight:bold; border-radius:4px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>

    <table id="mainTable">
        <thead>
            <tr>
                <th width="35">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th width="80">Ø§Ù„ÙŠÙˆÙ…</th>
                <th>8 ØµØ¨Ø§Ø­Ø§Ù‹ - 2 Ø¸Ù‡Ø±Ø§Ù‹</th>
                <th>2 Ø¸Ù‡Ø±Ø§Ù‹ - 8 Ù…Ø³Ø§Ø¡Ù‹</th>
                <th>8 Ù…Ø³Ø§Ø¡Ù‹ - 8 ØµØ¨Ø§Ø­Ø§Ù‹</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div class="codes-list">
        <div class="code-row"><input type="text" value="Ø§Ù„Ø§Ø¡ Ø¹Ø¨Ø¯Ø§Ù„Ù†Ø¨ÙŠ  1111 - Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ø­Ù…Ø¯  2222 - Ø­Ø³Ø§Ù… Ø­Ø³Ù†  3333"></div>
    </div>

    <div class="signatures-wrapper">
        <div class="sig-block"><div>Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ù†Ùƒ Ø§Ù„Ø¯Ù…</div><input type="text" value="Ø¯/ Ù…Ù‡Ø§ ÙØªÙˆØ­ ÙˆØ§Ù„ÙŠ"></div>
        <div class="sig-block"><div> Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</div><input type="text" value="Ø¯/ Ù…Ø­Ù…Ø¯ ØµÙ„Ø§Ø­ Ù‚Ø§Ø³Ù…"></div>
    </div>

    <div style="margin-top: 30px; border-top: 2px dashed #ccc; padding-top: 15px;">
        <button id="generateStatsBtn" onclick="calculateStats()" style="width: 100%; padding: 10px; background: #343a40; color: white; border: none; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 5px;">ğŸ“Š Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´ÙŠÙØªØ§Øª ÙˆØ§Ù„Ø³Ø§Ø¹Ø§Øª</button>
        <div id="statsContainer" style="display:none; margin-top: 15px;">
            <h3 style="text-align:center; margin-bottom:5px; text-decoration: underline;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª ÙˆØ§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙŠÙØªØ§Øª (Ø§Ù„ØµØ¨Ø§Ø­ÙŠ/Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠ)</th>
                        <th>Ø¹Ø¯Ø¯ Ø´ÙŠÙØªØ§Øª Ø§Ù„Ø³Ù‡Ø± (Ã—2)</th>
                        <th style="background:#28a745;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙŠÙØªØ§Øª Ø§Ù„Ù…Ø­ØªØ³Ø¨Ø©</th>
                        <th style="background:#dc3545;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="statsBody"></tbody>
            </table>
            <div style="font-size: 11px; margin-top: 5px; color: #666;">* Ù…Ù„Ø§Ø­Ø¸Ø©: Ø´ÙŠÙØª Ø§Ù„Ø³Ù‡Ø± (Ù„ÙŠÙ„Ø§Ù‹) ÙŠÙØ­Ø³Ø¨ Ø¨Ù€ 2 Ø´ÙŠÙØª (12 Ø³Ø§Ø¹Ø©).</div>
        </div>
    </div>

    <div class="controls-panel">
        <div id="activeWorkerDisplay" style="margin-bottom: 10px; font-weight: bold; color: #d32f2f;">
            Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹: <span id="currentWorkerName">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
            <button onclick="clearSelection()" style="margin-right:15px; font-size:11px; padding:3px 8px; cursor:pointer; background:#fff; border:1px solid #ccc; border-radius:3px;">Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
        </div>

        <div class="bulk-options">
            <strong style="color:#007bff; width: 100%; border-bottom: 1px solid #eee; margin-bottom: 5px;">âš¡ Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ…):</strong>
            <span>Ø§Ø®ØªØ± Ø§Ù„Ø£ÙŠØ§Ù…:</span>
            <label class="day-chip"><input type="checkbox" class="day-select" value="Ø§Ù„Ø³Ø¨Øª"> Ø§Ù„Ø³Ø¨Øª</label>
            <label class="day-chip"><input type="checkbox" class="day-select" value="Ø§Ù„Ø£Ø­Ø¯"> Ø§Ù„Ø£Ø­Ø¯</label>
            <label class="day-chip"><input type="checkbox" class="day-select" value="Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†"> Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</label>
            <label class="day-chip"><input type="checkbox" class="day-select" value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡"> Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</label>
            <label class="day-chip"><input type="checkbox" class="day-select" value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡"> Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</label>
            <label class="day-chip"><input type="checkbox" class="day-select" value="Ø§Ù„Ø®Ù…ÙŠØ³"> Ø§Ù„Ø®Ù…ÙŠØ³</label>
            <label class="day-chip"><input type="checkbox" class="day-select" value="Ø§Ù„Ø¬Ù…Ø¹Ø©"> Ø§Ù„Ø¬Ù…Ø¹Ø©</label>

            <div style="width: 10px; height: 20px; border-left: 2px solid #ddd; margin: 0 5px;"></div>
            <span>Ø§Ù„ÙØªØ±Ø©:</span>
            <label><input type="checkbox" class="shift-check" value="2"> ØµØ¨Ø§Ø­Ø§Ù‹</label>
            <label><input type="checkbox" class="shift-check" value="3"> Ù…Ø³Ø§Ø¡Ù‹</label>
            <label><input type="checkbox" class="shift-check" value="4"> Ù„ÙŠÙ„Ø§Ù‹</label>
            <button onclick="applyBulk()" style="background:#007bff; color:white; border:none; padding:8px 20px; cursor:pointer; border-radius:4px; font-weight:bold; margin-right: auto;">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¶Ø§ÙØ©</button>
        </div>

        <div id="palette" style="margin-bottom:10px; padding: 10px; background: #fff; border-radius: 5px; border: 1px solid #ccc;"></div>
        
        <div style="background: #fff; padding: 10px; border-radius: 5px; border: 1px solid #ccc; margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
            <div style="display: flex; gap: 8px; align-items: center;">
                <strong style="color: #28a745;">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©:</strong>
                <input type="text" id="newWorkerInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§..." style="padding: 6px; width: 180px; border: 1px solid #ccc; border-radius: 4px;">
                <button onclick="addNewWorkerToList()" style="background: #28a745; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;">Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…</button>
            </div>
            <div style="width: 2px; height: 30px; background: #eee;"></div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <strong style="color: #dc3545;">ğŸ—‘ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø°Ù:</strong>
                <button id="deleteWorkerBtn" onclick="deleteSelectedWorkers()" disabled style="background: #dc3545; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: not-allowed; font-weight: bold; opacity: 0.5;">Ø­Ø°Ù Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
            </div>
        </div>

        <div style="border-top:1px solid #ccc; padding-top:10px;">
            <input type="text" id="manualInput" placeholder="Ø§Ø³Ù… Ø¥Ø¶Ø§ÙÙŠ ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©..." style="padding:6px; width: 250px;">
            <button onclick="applyManual()" style="background: green; color: white; border: none; padding: 6px 20px; font-weight: bold; cursor:pointer;">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙŠØ¯ÙˆÙŠ</button>
            <button onclick="clearSelectedCell()" style="background: red; color: white; border: none; padding: 6px 15px; cursor:pointer;">Ù…Ø³Ø­ Ø§Ù„Ø®Ù„ÙŠØ©</button>
        </div>

        <div class="history-section" style="margin-top:15px; border-top:1px dashed #999; padding-top:10px;">
            <strong>ğŸ“š Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹:</strong> <div id="historyList"></div>
        </div>
    </div>
</div>

<script>
    let workers = JSON.parse(localStorage.getItem('nabatchy_worker_list')) || ["Ø®Ø§Ù„Ø¯ Ù‚Ø§Ø³Ù…", "Ù†Ø±Ù…ÙŠÙ† Ø·Ø§Ø±Ù‚", "Ø¬ÙŠÙ‡Ø§Ù† Ù†ØµØ±", "Ø¨Ø³Ù…Ø© Ù…Ø­Ù…Ø¯", "Ø§Ù„Ø§Ø¡ Ø¹Ø¨Ø¯ Ø§Ù„Ù†Ø¨ÙŠ", "Ø§Ù„Ø§Ø¡ Ù‚Ø§Ø³Ù…", "Ù…Ù‡Ø§ ÙˆØ§Ù„ÙŠ", "Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø§Ø­Ù…Ø¯", "Ø§Ø³Ù…Ø§Ø¹ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø§ÙˆÙŠ", "Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…ÙˆØ¯", "Ø­Ø³Ø§Ù… Ø­Ø³Ù†", "ÙˆÙØ§Ø¡ Ø§Ù„Ù†Ù…Ø±", "Ø§Ø­Ù…Ø¯ Ø§Ù„Ø­Ø³ÙŠÙ†ÙŠ"];
    let selectedWorkers = []; 
    let activeCell = null;

    function init() {
        refreshPalette();
        document.getElementById('monthSelect').value = new Date().getMonth() + 1;
        generateTable();
        refreshHistoryUI();
    }

    function refreshPalette() {
        const p = document.getElementById('palette');
        p.innerHTML = '';
        workers.forEach(name => {
            const btn = document.createElement('button');
            btn.className = 'worker-btn';
            if (selectedWorkers.includes(name)) btn.classList.add('active');
            btn.textContent = name;
            btn.onclick = () => toggleWorkerSelection(name, btn);
            p.appendChild(btn);
        });
        localStorage.setItem('nabatchy_worker_list', JSON.stringify(workers));
        updateUISelection();
    }

    function toggleWorkerSelection(name, btn) {
        if (selectedWorkers.includes(name)) {
            selectedWorkers = selectedWorkers.filter(w => w !== name);
            btn.classList.remove('active');
        } else {
            selectedWorkers.push(name);
            btn.classList.add('active');
        }
        updateUISelection();
    }

    function updateUISelection() {
        const display = document.getElementById('currentWorkerName');
        display.textContent = selectedWorkers.length > 0 ? selectedWorkers.join(' - ') : "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
        
        const delBtn = document.getElementById('deleteWorkerBtn');
        if (selectedWorkers.length > 0) {
            delBtn.disabled = false; delBtn.style.cursor = 'pointer'; delBtn.style.opacity = '1';
        } else {
            delBtn.disabled = true; delBtn.style.cursor = 'not-allowed'; delBtn.style.opacity = '0.5';
        }
    }

    function clearSelection() {
        selectedWorkers = [];
        refreshPalette();
    }

    function addNewWorkerToList() {
        const input = document.getElementById('newWorkerInput');
        const name = input.value.trim();
        if (name && !workers.includes(name)) {
            workers.push(name);
            input.value = '';
            refreshPalette();
        }
    }

    function deleteSelectedWorkers() {
        if (selectedWorkers.length === 0) return;
        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŸ`)) {
            workers = workers.filter(w => !selectedWorkers.includes(w));
            selectedWorkers = [];
            refreshPalette();
        }
    }

    function generateTable() {
        const month = parseInt(document.getElementById('monthSelect').value);
        const year = parseInt(document.getElementById('yearSelect').value);
        const tbody = document.getElementById('tableBody');
        const monthText = document.getElementById('monthSelect').options[month-1].text;
        document.getElementById('tableTitle').textContent = `Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠÙŠÙ† ÙˆØ§Ù„ÙÙ†ÙŠÙŠÙ† Ø¨Ø¨Ù†Ùƒ Ø§Ù„Ø¯Ù… Ø¹Ù† Ø´Ù‡Ø± ${monthText} ${year}`;
        tbody.innerHTML = '';
        const daysInMonth = new Date(year, month, 0).getDate();
        const arabicDays = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
        for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, month - 1, d);
            const row = document.createElement('tr');
            if (dateObj.getDay() === 5) row.style.backgroundColor = "#f2f2f2"; 
            row.innerHTML = `<td>${d}</td><td style="font-weight:bold;">${arabicDays[dateObj.getDay()]}</td>
                <td class="shift-cell" onclick="handleCellClick(this)"></td>
                <td class="shift-cell" onclick="handleCellClick(this)"></td>
                <td class="shift-cell" onclick="handleCellClick(this)"></td>`;
            tbody.appendChild(row);
        }
        document.getElementById('statsContainer').style.display = 'none'; // Hide stats on regeneration
    }

    function handleCellClick(cell) {
        if (selectedWorkers.length > 0) {
            selectedWorkers.forEach(name => addNameToCell(cell, name));
            activeCell = cell;
            cell.classList.add('selected-cell');
            return;
        }

        const content = cell.textContent.trim();
        if (content === "") return;

        const names = content.split(' - ').filter(n => n.trim() !== "");

        if (names.length === 1) {
            if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù "${names[0]}"ØŸ`)) {
                cell.textContent = "";
            }
        } else {
            let msg = "Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ©:\n";
            names.forEach((n, i) => {
                msg += `${i + 1}: ${n}\n`;
            });
            msg += "\nØ§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø­Ø°ÙÙ‡:";

            let input = prompt(msg);
            if (input !== null) {
                let index = parseInt(input) - 1;
                if (!isNaN(index) && index >= 0 && index < names.length) {
                    names.splice(index, 1);
                    cell.textContent = names.join(' - ');
                }
            }
        }

        if (activeCell) activeCell.classList.remove('selected-cell');
        activeCell = cell;
        cell.classList.add('selected-cell');
    }

    function addNameToCell(cell, name) {
        let existing = cell.textContent.split(' - ').map(x => x.trim()).filter(x => x !== "");
        if (!existing.includes(name)) {
            existing.push(name);
            cell.textContent = existing.join(' - ');
        }
    }

    function applyBulk() {
        if (selectedWorkers.length === 0) return alert("Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");
        const selectedDays = Array.from(document.querySelectorAll('.day-select:checked')).map(cb => cb.value);
        const selectedShifts = Array.from(document.querySelectorAll('.shift-check:checked')).map(cb => parseInt(cb.value));
        if (selectedDays.length === 0 || selectedShifts.length === 0) return alert("Ø­Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… ÙˆØ§Ù„ÙØªØ±Ø§Øª");

        const tbody = document.getElementById('tableBody');
        for (let row of tbody.rows) {
            if (selectedDays.includes(row.cells[1].textContent.trim())) {
                selectedShifts.forEach(sIdx => {
                    selectedWorkers.forEach(name => addNameToCell(row.cells[sIdx], name));
                });
            }
        }
    }

    function applyManual() {
        if (!activeCell) return alert("Ø§Ø®ØªØ± Ø®Ù„ÙŠØ©");
        const val = document.getElementById('manualInput').value.trim();
        if (val) { addNameToCell(activeCell, val); document.getElementById('manualInput').value = ''; }
    }

    function clearSelectedCell() { if (activeCell) activeCell.textContent = ''; }

    function saveToHistory() {
        const rows = document.getElementById('tableBody').rows;
        let data = [];
        for (let r of rows) data.push([r.cells[2].textContent, r.cells[3].textContent, r.cells[4].textContent]);
        
        const now = new Date();
        const arabicDays = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
        const defaultName = `${arabicDays[now.getDay()]} ${now.toLocaleDateString('ar-EG')} - ${now.getHours()}:${now.getMinutes()}`;
        
        let customName = prompt("Ù‚Ù… Ø¨ØªØ³Ù…ÙŠØ© Ø§Ù„Ù†Ø³Ø®Ø© (Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙˆÙ‚ÙŠØª):", defaultName);
        if (customName === null) return; 
        if (customName.trim() === "") customName = defaultName;

        let history = JSON.parse(localStorage.getItem('nabatchy_v5_history') || '[]');
        history.unshift({ name: customName, data: data });
        if (history.length > 15) history.pop();
        localStorage.setItem('nabatchy_v5_history', JSON.stringify(history));
        refreshHistoryUI();
    }

    function refreshHistoryUI() {
        const list = document.getElementById('historyList');
        const history = JSON.parse(localStorage.getItem('nabatchy_v5_history') || '[]');
        list.innerHTML = history.length ? '' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ù…Ø­ÙÙˆØ¸Ø©';
        
        history.forEach((item, index) => {
            let displayName = item.name || item.time;
            const div = document.createElement('div');
            div.className = 'history-tag';
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'history-name';
            nameSpan.textContent = displayName;
            nameSpan.onclick = () => loadHistoryItem(item);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'history-actions';
            
            const editBtn = document.createElement('span');
            editBtn.textContent = 'âœï¸';
            editBtn.title = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…';
            editBtn.onclick = (e) => { e.stopPropagation(); renameHistoryItem(index); };
            
            const delBtn = document.createElement('span');
            delBtn.textContent = 'âŒ';
            delBtn.style.color = 'red';
            delBtn.title = 'Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø©';
            delBtn.onclick = (e) => { e.stopPropagation(); deleteHistoryItem(index); };

            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(delBtn);
            div.appendChild(nameSpan);
            div.appendChild(actionsDiv);
            list.appendChild(div);
        });
    }

    function loadHistoryItem(item) {
        if(confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø©: "${item.name || item.time}"ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ.`)) {
            const tbody = document.getElementById('tableBody');
            item.data.forEach((r, i) => { 
                if(tbody.rows[i]) { 
                    tbody.rows[i].cells[2].textContent = r[0]; 
                    tbody.rows[i].cells[3].textContent = r[1]; 
                    tbody.rows[i].cells[4].textContent = r[2]; 
                } 
            });
        }
    }

    function renameHistoryItem(index) {
        let history = JSON.parse(localStorage.getItem('nabatchy_v5_history') || '[]');
        let currentName = history[index].name || history[index].time;
        let newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù†Ø³Ø®Ø©:", currentName);
        if (newName && newName.trim() !== "") {
            history[index].name = newName.trim();
            localStorage.setItem('nabatchy_v5_history', JSON.stringify(history));
            refreshHistoryUI();
        }
    }

    function deleteHistoryItem(index) {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©ØŸ")) {
            let history = JSON.parse(localStorage.getItem('nabatchy_v5_history') || '[]');
            history.splice(index, 1);
            localStorage.setItem('nabatchy_v5_history', JSON.stringify(history));
            refreshHistoryUI();
        }
    }

    function downloadBackup() {
        const rows = document.getElementById('tableBody').rows;
        let tableData = [];
        for (let r of rows) {
            tableData.push([r.cells[2].textContent, r.cells[3].textContent, r.cells[4].textContent]);
        }

        const backupObj = {
            month: document.getElementById('monthSelect').value,
            year: document.getElementById('yearSelect').value,
            workers: workers,
            data: tableData,
            savedAt: new Date().toISOString()
        };

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupObj));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "nabatchy_backup_" + new Date().toLocaleDateString('ar-EG').replace(/\//g, '-') + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function restoreBackup(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const backup = JSON.parse(e.target.result);
                if(backup.month) document.getElementById('monthSelect').value = backup.month;
                if(backup.year) document.getElementById('yearSelect').value = backup.year;
                if(backup.workers && Array.isArray(backup.workers)) {
                    workers = backup.workers;
                    localStorage.setItem('nabatchy_worker_list', JSON.stringify(workers));
                    refreshPalette();
                }
                generateTable();
                const tbody = document.getElementById('tableBody');
                if(backup.data && Array.isArray(backup.data)) {
                    backup.data.forEach((rowData, index) => {
                        if(tbody.rows[index]) {
                            tbody.rows[index].cells[2].textContent = rowData[0] || '';
                            tbody.rows[index].cells[3].textContent = rowData[1] || '';
                            tbody.rows[index].cells[4].textContent = rowData[2] || '';
                        }
                    });
                }
                alert("ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø¨Ù†Ø¬Ø§Ø­!");
            } catch (err) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£! Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù.");
                console.error(err);
            }
        };
        reader.readAsText(file);
        input.value = ''; 
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
    function calculateStats() {
        let stats = {};
        
        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®Ù„ÙŠØ©
        // shiftCount: 1 Ù„Ù„ØµØ¨Ø§Ø­ÙŠ/Ù…Ø³Ø§Ø¦ÙŠØŒ 2 Ù„Ù„Ø³Ù‡Ø±
        // hourCount: 6 Ù„Ù„ØµØ¨Ø§Ø­ÙŠ/Ù…Ø³Ø§Ø¦ÙŠØŒ 12 Ù„Ù„Ø³Ù‡Ø±
        const processCell = (cellContent, shiftCount, hourCount, type) => {
            if (!cellContent.trim()) return;
            const names = cellContent.split(' - ').map(n => n.trim()).filter(n => n);
            names.forEach(name => {
                if (!stats[name]) {
                    stats[name] = { normalShifts: 0, nightShifts: 0, totalShifts: 0, totalHours: 0 };
                }
                if (type === 'night') {
                    stats[name].nightShifts += 1;
                } else {
                    stats[name].normalShifts += 1;
                }
                stats[name].totalShifts += shiftCount;
                stats[name].totalHours += hourCount;
            });
        };

        const rows = document.getElementById('tableBody').rows;
        for (let row of rows) {
            // Ø§Ù„Ø®Ù„ÙŠØ© 2: ØµØ¨Ø§Ø­ÙŠ (8-2)
            processCell(row.cells[2].textContent, 1, 6, 'normal');
            // Ø§Ù„Ø®Ù„ÙŠØ© 3: Ù…Ø³Ø§Ø¦ÙŠ (2-8)
            processCell(row.cells[3].textContent, 1, 6, 'normal');
            // Ø§Ù„Ø®Ù„ÙŠØ© 4: Ø³Ù‡Ø± (8-8)
            processCell(row.cells[4].textContent, 2, 12, 'night');
        }

        const statsBody = document.getElementById('statsBody');
        statsBody.innerHTML = '';
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø¦Ù† Ù„Ù…ØµÙÙˆÙØ© Ù„Ù„ØªØ±ØªÙŠØ¨
        const sortedNames = Object.keys(stats).sort();

        if (sortedNames.length === 0) {
            statsBody.innerHTML = '<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ø³Ø§Ø¨Ù‡Ø§. Ø§Ù…Ù„Ø£ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.</td></tr>';
        } else {
            sortedNames.forEach(name => {
                const s = stats[name];
                const tr = document.createElement('tr');
                tr.className = 'stats-row';
                tr.innerHTML = `
                    <td style="text-align:right; padding-right:10px;">${name}</td>
                    <td>${s.normalShifts}</td>
                    <td>${s.nightShifts} <span style="font-size:10px; color:#666;">(Ã—2=${s.nightShifts*2})</span></td>
                    <td style="background:#e8f5e9; color:#2e7d32;">${s.totalShifts}</td>
                    <td style="background:#ffebee; color:#c62828;">${s.totalHours} Ø³Ø§Ø¹Ø©</td>
                `;
                statsBody.appendChild(tr);
            });
        }

        document.getElementById('statsContainer').style.display = 'block';
        // Ø§Ù„Ù†Ø²ÙˆÙ„ Ù„Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        document.getElementById('statsContainer').scrollIntoView({ behavior: 'smooth' });
    }

    window.onload = init;
</script>
</body>
</html>
